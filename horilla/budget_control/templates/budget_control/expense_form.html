{% extends 'index.html' %}
{% load i18n %}
{% load static %}

{% block title %}
    {% trans "Submit Expense" %}
{% endblock %}

{% block content %}
<div class="oh-wrapper">
    <div class="oh-main-container">
        <div class="oh-main-content">
            <!-- Page Header -->
            <div class="oh-title-container">
                <div class="oh-title-path">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'budget-dashboard' %}">{% trans "Budget Control" %}</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'expense-list' %}">{% trans "Expenses" %}</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                {% trans "Submit" %}
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="oh-title">
                    <h1 class="oh-title-text">{% trans "Submit Expense" %}</h1>
                </div>
            </div>

            <!-- Form -->
            <div class="oh-card">
                <div class="oh-card__body">
                    <form method="post" enctype="multipart/form-data" class="oh-form">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="row">
                            <!-- Expense Information -->
                            <div class="col-md-6">
                                <fieldset class="oh-fieldset">
                                    <legend class="oh-fieldset__legend">{% trans "Expense Information" %}</legend>
                                    
                                    <div class="oh-form-group">
                                        <label for="{{ form.budget.id_for_label }}" class="oh-form-label">
                                            {{ form.budget.label }}
                                            {% if form.budget.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ form.budget }}
                                        {% if form.budget.errors %}
                                            <div class="oh-form-error">{{ form.budget.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Select the budget this expense should be charged to" %}</small>
                                    </div>

                                    <div class="oh-form-group">
                                        <label for="{{ form.description.id_for_label }}" class="oh-form-label">
                                            {{ form.description.label }}
                                            {% if form.description.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ form.description }}
                                        {% if form.description.errors %}
                                            <div class="oh-form-error">{{ form.description.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Provide a detailed description of the expense" %}</small>
                                    </div>

                                    <div class="oh-form-group">
                                        <label for="{{ form.purpose.id_for_label }}" class="oh-form-label">
                                            {{ form.purpose.label }}
                                        </label>
                                        {{ form.purpose }}
                                        {% if form.purpose.errors %}
                                            <div class="oh-form-error">{{ form.purpose.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Business purpose or reason for this expense" %}</small>
                                    </div>
                                </fieldset>
                            </div>

                            <!-- Amount and Date -->
                            <div class="col-md-6">
                                <fieldset class="oh-fieldset">
                                    <legend class="oh-fieldset__legend">{% trans "Amount & Date" %}</legend>
                                    
                                    <div class="oh-form-group">
                                        <label for="{{ form.amount.id_for_label }}" class="oh-form-label">
                                            {{ form.amount.label }}
                                            {% if form.amount.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            {{ form.amount }}
                                        </div>
                                        {% if form.amount.errors %}
                                            <div class="oh-form-error">{{ form.amount.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Enter the expense amount in USD" %}</small>
                                    </div>

                                    <div class="oh-form-group">
                                        <label for="{{ form.expense_date.id_for_label }}" class="oh-form-label">
                                            {{ form.expense_date.label }}
                                            {% if form.expense_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ form.expense_date }}
                                        {% if form.expense_date.errors %}
                                            <div class="oh-form-error">{{ form.expense_date.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Date when the expense was incurred" %}</small>
                                    </div>

                                    <div class="oh-form-group">
                                        <label for="{{ form.receipt.id_for_label }}" class="oh-form-label">
                                            {{ form.receipt.label }}
                                        </label>
                                        {{ form.receipt }}
                                        {% if form.receipt.errors %}
                                            <div class="oh-form-error">{{ form.receipt.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">{% trans "Upload receipt or supporting document (PDF, JPG, PNG)" %}</small>
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <!-- Budget Information Display -->
                        <div class="row mt-4" id="budgetInfo" style="display: none;">
                            <div class="col-12">
                                <div class="oh-card oh-card--info">
                                    <div class="oh-card__header">
                                        <h5 class="oh-card__title">{% trans "Selected Budget Information" %}</h5>
                                    </div>
                                    <div class="oh-card__body">
                                        <div class="row" id="budgetDetails">
                                            <!-- Budget details will be loaded here via AJAX -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="oh-form-actions mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> {% trans "Submit Expense" %}
                            </button>
                            <a href="{% url 'expense-list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Date picker initialization
    if ($.fn.datepicker) {
        $('#id_expense_date').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            endDate: 'today'
        });
    }
    
    // Budget selection change handler
    $('#id_budget').on('change', function() {
        var budgetId = $(this).val();
        if (budgetId) {
            // Load budget information via AJAX
            $.get('/budget-control/api/budget/' + budgetId + '/', function(data) {
                var budgetHtml = '<div class="col-md-3">' +
                    '<div class="oh-stats oh-stats--small">' +
                    '<div class="oh-stats__content">' +
                    '<h4 class="oh-stats__number">$' + parseFloat(data.total_amount).toFixed(2) + '</h4>' +
                    '<p class="oh-stats__label">{% trans "Total Budget" %}</p>' +
                    '</div></div></div>' +
                    '<div class="col-md-3">' +
                    '<div class="oh-stats oh-stats--small">' +
                    '<div class="oh-stats__content">' +
                    '<h4 class="oh-stats__number">$' + parseFloat(data.spent_amount).toFixed(2) + '</h4>' +
                    '<p class="oh-stats__label">{% trans "Spent" %}</p>' +
                    '</div></div></div>' +
                    '<div class="col-md-3">' +
                    '<div class="oh-stats oh-stats--small">' +
                    '<div class="oh-stats__content">' +
                    '<h4 class="oh-stats__number">$' + parseFloat(data.remaining_amount).toFixed(2) + '</h4>' +
                    '<p class="oh-stats__label">{% trans "Remaining" %}</p>' +
                    '</div></div></div>' +
                    '<div class="col-md-3">' +
                    '<div class="oh-stats oh-stats--small">' +
                    '<div class="oh-stats__content">' +
                    '<h4 class="oh-stats__number">' + parseFloat(data.utilization_percentage).toFixed(1) + '%</h4>' +
                    '<p class="oh-stats__label">{% trans "Utilization" %}</p>' +
                    '</div></div></div>';
                
                $('#budgetDetails').html(budgetHtml);
                $('#budgetInfo').show();
            }).fail(function() {
                $('#budgetInfo').hide();
            });
        } else {
            $('#budgetInfo').hide();
        }
    });
    
    // Form validation
    $('form').on('submit', function(e) {
        var amount = parseFloat($('#id_amount').val());
        var budgetId = $('#id_budget').val();
        
        if (amount <= 0) {
            e.preventDefault();
            alert('{% trans "Amount must be greater than zero" %}');
            return false;
        }
        
        if (!budgetId) {
            e.preventDefault();
            alert('{% trans "Please select a budget" %}');
            return false;
        }
    });
    
    // File upload validation
    $('#id_receipt').on('change', function() {
        var file = this.files[0];
        if (file) {
            var fileSize = file.size / 1024 / 1024; // Convert to MB
            var allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
            
            if (fileSize > 5) {
                alert('{% trans "File size must be less than 5MB" %}');
                $(this).val('');
                return false;
            }
            
            if (allowedTypes.indexOf(file.type) === -1) {
                alert('{% trans "Only JPG, PNG, GIF, and PDF files are allowed" %}');
                $(this).val('');
                return false;
            }
        }
    });
    
    // Pre-select budget if provided in URL
    var urlParams = new URLSearchParams(window.location.search);
    var budgetParam = urlParams.get('budget');
    if (budgetParam) {
        $('#id_budget').val(budgetParam).trigger('change');
    }
});
</script>
{% endblock %}