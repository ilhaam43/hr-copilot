{% extends 'index.html' %}
{% load i18n %}
{% load static %}

{% block title %}
    {% trans "Expense Detail" %} - {{ expense.description|truncatechars:30 }}
{% endblock %}

{% block content %}
<div class="oh-wrapper">
    <div class="oh-main-container">
        <div class="oh-main-content">
            <!-- Page Header -->
            <div class="oh-title-container">
                <div class="oh-title-path">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'budget-dashboard' %}">{% trans "Budget Control" %}</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'expense-list' %}">{% trans "Expenses" %}</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                {{ expense.description|truncatechars:30 }}
                            </li>
                        </ol>
                    </nav>
                </div>
                <div class="oh-title">
                    <h1 class="oh-title-text">{% trans "Expense Detail" %}</h1>
                    <div class="oh-title-actions">
                        {% if expense.status == 'pending' and expense.employee == request.user.employee %}
                            <a href="{% url 'expense-edit' expense.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-edit"></i> {% trans "Edit" %}
                            </a>
                        {% endif %}
                        {% if perms.budget_control.delete_expense and expense.status == 'pending' %}
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash"></i> {% trans "Delete" %}
                            </button>
                        {% endif %}
                        <a href="{% url 'expense-list' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
                        </a>
                    </div>
                </div>
            </div>

            <!-- Expense Status and Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="oh-card">
                        <div class="oh-card__body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">{{ expense.description }}</h5>
                                    <p class="text-muted mb-0">
                                        {% trans "Submitted by" %} {{ expense.employee.employee_first_name }} {{ expense.employee.employee_last_name }}
                                        {% trans "on" %} {{ expense.created_at|date:"M d, Y" }}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge badge-lg 
                                        {% if expense.status == 'approved' %}badge-success
                                        {% elif expense.status == 'rejected' %}badge-danger
                                        {% elif expense.status == 'paid' %}badge-info
                                        {% else %}badge-warning{% endif %}">
                                        {{ expense.get_status_display }}
                                    </span>
                                    <div class="mt-2">
                                        {% if perms.budget_control.change_expense and expense.status == 'pending' %}
                                            <button type="button" class="btn btn-success btn-sm me-2" onclick="updateExpenseStatus('approved')">
                                                <i class="fas fa-check"></i> {% trans "Approve" %}
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="updateExpenseStatus('rejected')">
                                                <i class="fas fa-times"></i> {% trans "Reject" %}
                                            </button>
                                        {% endif %}
                                        {% if perms.budget_control.change_expense and expense.status == 'approved' %}
                                            <button type="button" class="btn btn-info btn-sm" onclick="updateExpenseStatus('paid')">
                                                <i class="fas fa-money-bill"></i> {% trans "Mark as Paid" %}
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expense Information -->
            <div class="row">
                <div class="col-md-8">
                    <div class="oh-card">
                        <div class="oh-card__header">
                            <h5 class="oh-card__title">{% trans "Expense Information" %}</h5>
                        </div>
                        <div class="oh-card__body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold">{% trans "Budget" %}:</td>
                                            <td>
                                                <a href="{% url 'budget-detail' expense.budget.id %}">
                                                    {{ expense.budget.name }}
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Department" %}:</td>
                                            <td>{{ expense.budget.department.department }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Category" %}:</td>
                                            <td>{{ expense.budget.category.name }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Amount" %}:</td>
                                            <td class="fw-bold text-primary">${{ expense.amount|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Expense Date" %}:</td>
                                            <td>{{ expense.expense_date|date:"M d, Y" }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td class="fw-bold">{% trans "Employee" %}:</td>
                                            <td>{{ expense.employee.employee_first_name }} {{ expense.employee.employee_last_name }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Employee ID" %}:</td>
                                            <td>{{ expense.employee.badge_id }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Submitted" %}:</td>
                                            <td>{{ expense.created_at|date:"M d, Y H:i" }}</td>
                                        </tr>
                                        {% if expense.approved_by %}
                                        <tr>
                                            <td class="fw-bold">{% trans "Approved By" %}:</td>
                                            <td>{{ expense.approved_by.employee_first_name }} {{ expense.approved_by.employee_last_name }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">{% trans "Approved Date" %}:</td>
                                            <td>{{ expense.approved_at|date:"M d, Y H:i" }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                            
                            {% if expense.description %}
                            <div class="mt-3">
                                <h6 class="fw-bold">{% trans "Description" %}:</h6>
                                <p class="text-muted">{{ expense.description }}</p>
                            </div>
                            {% endif %}
                            
                            {% if expense.purpose %}
                            <div class="mt-3">
                                <h6 class="fw-bold">{% trans "Business Purpose" %}:</h6>
                                <p class="text-muted">{{ expense.purpose }}</p>
                            </div>
                            {% endif %}
                            
                            {% if expense.rejection_reason %}
                            <div class="mt-3">
                                <div class="alert alert-danger">
                                    <h6 class="fw-bold mb-2">{% trans "Rejection Reason" %}:</h6>
                                    <p class="mb-0">{{ expense.rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Receipt -->
                    {% if expense.receipt %}
                    <div class="oh-card mb-4">
                        <div class="oh-card__header">
                            <h5 class="oh-card__title">{% trans "Receipt" %}</h5>
                        </div>
                        <div class="oh-card__body text-center">
                            {% if expense.receipt.url|slice:"-4:" == '.pdf' %}
                                <div class="mb-3">
                                    <i class="fas fa-file-pdf fa-3x text-danger"></i>
                                    <p class="mt-2 mb-0">{% trans "PDF Document" %}</p>
                                </div>
                                <a href="{{ expense.receipt.url }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> {% trans "View PDF" %}
                                </a>
                            {% else %}
                                <img src="{{ expense.receipt.url }}" alt="{% trans 'Receipt' %}" class="img-fluid mb-3" style="max-height: 300px;">
                                <div class="mt-2">
                                <a href="{{ expense.receipt.url }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-expand"></i> {% trans "View Full Size" %}
                                </a>
                                </div>
                            {% endif %}
                            <div class="mt-2">
                            <a href="{{ expense.receipt.url }}" download class="btn btn-secondary btn-sm">
                                <i class="fas fa-download"></i> {% trans "Download" %}
                            </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Budget Summary -->
                    <div class="oh-card">
                        <div class="oh-card__header">
                            <h5 class="oh-card__title">{% trans "Budget Summary" %}</h5>
                        </div>
                        <div class="oh-card__body">
                            <div class="oh-stats oh-stats--small mb-3">
                                <div class="oh-stats__content">
                                    <h4 class="oh-stats__number">${{ expense.budget.total_amount|floatformat:2 }}</h4>
                                    <p class="oh-stats__label">{% trans "Total Budget" %}</p>
                                </div>
                            </div>
                            <div class="oh-stats oh-stats--small mb-3">
                                <div class="oh-stats__content">
                                    <h4 class="oh-stats__number">${{ expense.budget.spent_amount|floatformat:2 }}</h4>
                                    <p class="oh-stats__label">{% trans "Spent" %}</p>
                                </div>
                            </div>
                            <div class="oh-stats oh-stats--small mb-3">
                                <div class="oh-stats__content">
                                    <h4 class="oh-stats__number">${{ expense.budget.remaining_amount|floatformat:2 }}</h4>
                                    <p class="oh-stats__label">{% trans "Remaining" %}</p>
                                </div>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar 
                                    {% if expense.budget.utilization_percentage >= 90 %}bg-danger
                                    {% elif expense.budget.utilization_percentage >= 75 %}bg-warning
                                    {% else %}bg-success{% endif %}"
                                    role="progressbar" 
                                    style="width: {{ expense.budget.utilization_percentage }}%"
                                    aria-valuenow="{{ expense.budget.utilization_percentage }}"
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">{{ expense.budget.utilization_percentage|floatformat:1 }}% {% trans "utilized" %}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">{% trans "Confirm Delete" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% trans "Are you sure you want to delete this expense? This action cannot be undone." %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <form method="post" action="{% url 'expense-delete' expense.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">{% trans "Update Expense Status" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="statusForm" method="post" action="{% url 'expense-update-status' expense.id %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" id="statusInput" name="status" value="">
                    <div id="statusMessage"></div>
                    <div id="rejectionReasonDiv" style="display: none;">
                        <label for="rejectionReason" class="form-label">{% trans "Rejection Reason" %} <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rejectionReason" name="rejection_reason" rows="3" placeholder="{% trans 'Please provide a reason for rejection' %}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary" id="statusSubmitBtn">{% trans "Update" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateExpenseStatus(status) {
    $('#statusInput').val(status);
    
    var messages = {
        'approved': '{% trans "Are you sure you want to approve this expense?" %}',
        'rejected': '{% trans "Are you sure you want to reject this expense?" %}',
        'paid': '{% trans "Are you sure you want to mark this expense as paid?" %}'
    };
    
    var buttonTexts = {
        'approved': '{% trans "Approve" %}',
        'rejected': '{% trans "Reject" %}',
        'paid': '{% trans "Mark as Paid" %}'
    };
    
    var buttonClasses = {
        'approved': 'btn-success',
        'rejected': 'btn-danger',
        'paid': 'btn-info'
    };
    
    $('#statusMessage').html('<p>' + messages[status] + '</p>');
    $('#statusSubmitBtn').text(buttonTexts[status]);
    $('#statusSubmitBtn').removeClass('btn-primary btn-success btn-danger btn-info').addClass(buttonClasses[status]);
    
    if (status === 'rejected') {
        $('#rejectionReasonDiv').show();
        $('#rejectionReason').prop('required', true);
    } else {
        $('#rejectionReasonDiv').hide();
        $('#rejectionReason').prop('required', false);
    }
    
    $('#statusModal').modal('show');
}

$(document).ready(function() {
    // Form validation for status update
    $('#statusForm').on('submit', function(e) {
        var status = $('#statusInput').val();
        if (status === 'rejected') {
            var reason = $('#rejectionReason').val().trim();
            if (!reason) {
                e.preventDefault();
                alert('{% trans "Please provide a rejection reason" %}');
                return false;
            }
        }
    });
});
</script>
{% endblock %}