{% extends 'index.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "NLP Analytics Dashboard" %}{% endblock %}

{% block extra_css %}
<style>
.nlp-dashboard {
    padding: 20px;
}

.stats-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.stats-card.positive {
    border-left-color: #28a745;
}

.stats-card.negative {
    border-left-color: #dc3545;
}

.stats-card.neutral {
    border-left-color: #ffc107;
}

.stats-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stats-label {
    color: #666;
    font-size: 0.9rem;
}

.sentiment-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.sentiment-positive {
    background-color: #d4edda;
    color: #155724;
}

.sentiment-negative {
    background-color: #f8d7da;
    color: #721c24;
}

.sentiment-neutral {
    background-color: #fff3cd;
    color: #856404;
}

.alert-item {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.entity-tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8rem;
    margin: 2px;
}

.intent-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.progress-bar {
    background-color: #e9ecef;
    border-radius: 4px;
    height: 8px;
    overflow: hidden;
}

.progress-fill {
    background-color: #007bff;
    height: 100%;
    transition: width 0.3s ease;
}

.filter-controls {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="nlp-dashboard">
    <div class="row">
        <div class="col-12">
            <h1>{% trans "NLP Analytics Dashboard" %}</h1>
            <p class="text-muted">{% trans "Sentiment analysis and insights from HR communications" %}</p>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls">
        <form method="get" class="row align-items-end">
            <div class="col-md-3">
                <label for="days" class="form-label">{% trans "Time Period" %}</label>
                <select name="days" id="days" class="form-select" onchange="this.form.submit()">
                    <option value="7" {% if days == 7 %}selected{% endif %}>{% trans "Last 7 days" %}</option>
                    <option value="30" {% if days == 30 %}selected{% endif %}>{% trans "Last 30 days" %}</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>{% trans "Last 90 days" %}</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>{% trans "Last year" %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary" onclick="refreshData()">{% trans "Refresh" %}</button>
            </div>
        </form>
    </div>

    <!-- Overview Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ insights.total_analyses }}</div>
                <div class="stats-label">{% trans "Total Analyses" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card {% if insights.average_sentiment_score > 0.1 %}positive{% elif insights.average_sentiment_score < -0.1 %}negative{% else %}neutral{% endif %}">
                <div class="stats-number">{{ insights.average_sentiment_score|floatformat:2 }}</div>
                <div class="stats-label">{% trans "Average Sentiment" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card positive">
                <div class="stats-number">
                    {% for dist in insights.sentiment_distribution %}
                        {% if dist.sentiment == 'positive' %}{{ dist.count }}{% endif %}
                    {% endfor %}
                </div>
                <div class="stats-label">{% trans "Positive Items" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card negative">
                <div class="stats-number">
                    {% for dist in insights.sentiment_distribution %}
                        {% if dist.sentiment == 'negative' %}{{ dist.count }}{% endif %}
                    {% endfor %}
                </div>
                <div class="stats-label">{% trans "Negative Items" %}</div>
            </div>
        </div>
    </div>

    <!-- Sentiment Distribution Chart -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h3>{% trans "Sentiment Trends" %}</h3>
                <canvas id="sentimentTrendsChart" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h3>{% trans "Sentiment Distribution" %}</h3>
                <canvas id="sentimentPieChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Source Breakdown -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>{% trans "Analysis by Source" %}</h3>
                {% for source in insights.source_breakdown %}
                <div class="intent-item">
                    <div>
                        <strong>{{ source.source_type|title }}</strong>
                        <small class="text-muted">({{ source.count }} items)</small>
                    </div>
                    <div>
                        <span class="sentiment-badge sentiment-{% if source.avg_sentiment > 0.1 %}positive{% elif source.avg_sentiment < -0.1 %}negative{% else %}neutral{% endif %}">
                            {{ source.avg_sentiment|floatformat:2 }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">{% trans "No data available" %}</p>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h3>{% trans "Top Entities" %}</h3>
                {% for entity in top_entities %}
                <div class="entity-tag">
                    {{ entity.entity_text }} ({{ entity.count }})
                </div>
                {% empty %}
                <p class="text-muted">{% trans "No entities detected" %}</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Alerts and Recent Activity -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h3>{% trans "Sentiment Alerts" %}</h3>
                <p class="text-muted">{% trans "Items requiring attention (negative sentiment)" %}</p>
                {% for alert in alerts %}
                <div class="alert-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <small class="text-muted">{{ alert.source_type|title }} - {{ alert.created_at }}</small>
                            <p class="mb-1">{{ alert.text_preview }}</p>
                        </div>
                        <span class="sentiment-badge sentiment-negative">
                            {{ alert.sentiment_score|floatformat:2 }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> {% trans "No negative sentiment alerts" %}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h3>{% trans "Recent Analyses" %}</h3>
                {% for analysis in recent_analyses %}
                <div class="intent-item">
                    <div>
                        <strong>{{ analysis.source_type|title }}</strong>
                        <br>
                        <small class="text-muted">{{ analysis.created_at|date:"M d, H:i" }}</small>
                        <br>
                        <small>{{ analysis.text_content|truncatechars:60 }}</small>
                    </div>
                    <div>
                        <span class="sentiment-badge sentiment-{{ analysis.sentiment }}">
                            {{ analysis.sentiment|title }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">{% trans "No recent analyses" %}</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Intents -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h3>{% trans "Common Intents" %}</h3>
                <div class="row">
                    {% for intent in top_intents %}
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{{ intent.intent_type|title }}</h5>
                                <p class="card-text">
                                    <span class="stats-number">{{ intent.count }}</span><br>
                                    <small class="text-muted">{{ intent.avg_confidence|floatformat:2 }} confidence</small>
                                </p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <p class="text-muted">{% trans "No intents detected" %}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Data from Django
const sentimentTrends = JSON.parse('{{ sentiment_trends|escapejs }}');
const sentimentDistribution = JSON.parse('{{ insights.sentiment_distribution|escapejs }}');

// Sentiment Trends Chart
const trendsCtx = document.getElementById('sentimentTrendsChart').getContext('2d');
const trendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: sentimentTrends.map(item => item.date),
        datasets: [{
            label: 'Average Sentiment',
            data: sentimentTrends.map(item => item.avg_sentiment),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                min: -1,
                max: 1
            }
        }
    }
});

// Sentiment Distribution Pie Chart
const pieCtx = document.getElementById('sentimentPieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: sentimentDistribution.map(item => item.sentiment.charAt(0).toUpperCase() + item.sentiment.slice(1)),
        datasets: [{
            data: sentimentDistribution.map(item => item.count),
            backgroundColor: [
                '#28a745',  // positive - green
                '#dc3545',  // negative - red
                '#ffc107'   // neutral - yellow
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

function refreshData() {
    location.reload();
}

// Auto-refresh every 5 minutes
setInterval(refreshData, 300000);
</script>
{% endblock %}